'use client';

import { useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Lock, Beaker, Send, Copy, FileJson } from 'lucide-react';
import { encryptAes, customUrlEncode } from '@/lib/crypto';
import { useToast } from '@/hooks/use-toast';

type Parameter = {
  name: string;
  type: string;
  source?: string;
  default?: string | number;
  hint?: string;
};

type Template = {
  value: string;
  description: string;
  parameters: Parameter[];
};

const commandTemplates: Record<string, Template> = {
  SUB_GR_GAME_PING: {
    value: 'SUB_GR_GAME_PING',
    description: "Forges a PING request, ensuring valid session data is encrypted.",
    parameters: [
      { name: 'id', type: 'Integer', source: 'Session Data', default: 12345 },
      { name: 'token', type: 'String', source: 'Session Data', default: 'session_token_abc' },
    ],
  },
  SUB_MB_LOGON_GETJPSCORE: {
    value: 'SUB_MB_LOGON_GETJPSCORE',
    description: "Requests Jackpot Score. Use for enumeration or potential tampering.",
    parameters: [
      { name: 'bossid', type: 'Integer', source: 'LogicMgr.login.bossID', default: 9876 },
    ],
  },
  FORGED_WIN_SCORE_UPDATE: {
    value: 'FORGED_WIN_SCORE_UPDATE',
    description: "Simulates winning/score update message. Target for fuzzing.",
    parameters: [
      { name: 'userid', type: 'Integer', source: 'LogicMgr.login.userID', default: 12345 },
      { name: 'score', type: 'Decimal', default: '999999999.99', hint: "Attempting unauthorized score injection." },
      { name: 'dynamicpass', type: 'String', source: 'LogicMgr.login.dynamicPass', default: 'dynamic_pass_xyz' },
    ],
  },
};

const ExploitationPayloadGenerator = () => {
  const [selectedTemplate, setSelectedTemplate] = useState<Template | null>(null);
  const [payload, setPayload] = useState<Record<string, any>>({});
  const [encryptedPayload, setEncryptedPayload] = useState('');
  const [customUrlJson, setCustomUrlJson] = useState('{\n  "id": "user123",\n  "pwd": "password_hash",\n  "musicVol": 0.5\n}');
  const [finalUrlParams, setFinalUrlParams] = useState('');
  const { toast } = useToast();

  const handleTemplateChange = (value: string) => {
    const template = commandTemplates[value];
    setSelectedTemplate(template);
    const initialPayload = template.parameters.reduce((acc, param) => {
      acc[param.name] = param.default ?? '';
      return acc;
    }, {} as Record<string, any>);
    setPayload(initialPayload);
    setEncryptedPayload('');
  };

  const handlePayloadChange = (name: string, value: string) => {
    setPayload(prev => ({ ...prev, [name]: value }));
  };

  const handleEncrypt = () => {
    const result = encryptAes(JSON.stringify(payload));
    setEncryptedPayload(result);
  };
  
  const handleInject = () => {
    toast({
        title: "Simulation Successful",
        description: "Payload injected into WebSocket (simulated).",
        variant: "default",
        className: "bg-accent text-accent-foreground border-accent"
    });
  }
  
  const handleCopy = (text: string) => {
    navigator.clipboard.writeText(text);
    toast({ description: "Copied to clipboard!" });
  }

  const handleEncodeUrl = () => {
    const result = customUrlEncode(customUrlJson);
    setFinalUrlParams(result);
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2"><Beaker className="text-primary"/> Command Forging</CardTitle>
          <CardDescription>Construct and encrypt malicious game commands from templates.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div>
            <Label>Command Template</Label>
            <Select onValueChange={handleTemplateChange}>
              <SelectTrigger className="w-full mt-2">
                <SelectValue placeholder="Select a command template to forge..." />
              </SelectTrigger>
              <SelectContent>
                {Object.values(commandTemplates).map(template => (
                  <SelectItem key={template.value} value={template.value}>
                    {template.value}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            {selectedTemplate && <p className="text-xs text-muted-foreground mt-2">{selectedTemplate.description}</p>}
          </div>

          {selectedTemplate && (
            <div className="space-y-4">
              <h3 className="font-semibold">Parameters</h3>
              {selectedTemplate.parameters.map(param => (
                <div key={param.name}>
                  <Label htmlFor={param.name}>{param.name} ({param.type})</Label>
                  <Input
                    id={param.name}
                    type={param.type === 'Integer' || param.type === 'Decimal' ? 'text' : 'text'}
                    value={payload[param.name]}
                    onChange={e => handlePayloadChange(param.name, e.target.value)}
                    className="mt-2 font-code"
                    placeholder={param.hint}
                  />
                  {param.source && <p className="text-xs text-muted-foreground mt-1">Source: {param.source}</p>}
                </div>
              ))}
            </div>
          )}
          
          <div className="space-y-4">
             <Button onClick={handleEncrypt} disabled={!selectedTemplate} className="w-full">
              <Lock className="mr-2" /> 1. Encrypt Payload
            </Button>
            
            <div className="relative">
                <Label>Encrypted Ciphertext (Server-Ready)</Label>
                <Input readOnly value={encryptedPayload} className="mt-2 font-code pr-10" />
                <Button variant="ghost" size="icon" className="absolute right-1 top-7 h-8 w-8" onClick={() => handleCopy(encryptedPayload)} disabled={!encryptedPayload}>
                    <Copy className="h-4 w-4"/>
                </Button>
            </div>

            <Button onClick={handleInject} disabled={!encryptedPayload} variant="secondary" className="w-full text-accent border border-accent hover:bg-accent/10">
              <Send className="mr-2" /> 2. Inject into WebSocket
            </Button>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2"><FileJson className="text-primary"/> URL Parameter Tampering</CardTitle>
          <CardDescription>Encode sensitive data using the target's weak custom encryption for URL injection.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label>Custom URL JSON</Label>
            <Textarea 
              value={customUrlJson}
              onChange={(e) => setCustomUrlJson(e.target.value)}
              className="mt-2 font-code h-32"
              placeholder='{ "id": "user123", "pwd": "password_hash" }'
            />
          </div>
          <Button onClick={handleEncodeUrl} className="w-full">Encode URL Payload</Button>
          <div className="relative">
            <Label>Final URL Parameters (Weakly Encrypted)</Label>
            <Input readOnly value={finalUrlParams} className="mt-2 font-code pr-10" placeholder="Ready to inject into browser's address bar"/>
            <Button variant="ghost" size="icon" className="absolute right-1 top-7 h-8 w-8" onClick={() => handleCopy(finalUrlParams)} disabled={!finalUrlParams}>
                <Copy className="h-4 w-4"/>
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default ExploitationPayloadGenerator;
